<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>SparroWatch Dashboard</title>
	<link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="node_modules/leaflet/dist/leaflet.css">
	<link rel="stylesheet" href="node_modules/font-awesome/css/font-awesome.min.css">
	<link rel="stylesheet" href="node_modules/gentelella/build/css/custom.css">
	<link rel="stylesheet" href="assets/css/style.css">

</head>

<body class="nav-md">

	<div class="container body">
		<div class="main_container">
			<div class="col-md-3 left_col">
				<div class="navbar nav_title" style="border: 0;">
					<a href="/" class="site_title"><i class="fa fa-tree"></i> <span>SparroWatch</span></a>
				</div>
			</div>
			<!-- top nav -->
			<div class="top_nav">

				<div class="nav_menu">
					<nav class="" role="navigation">
						<div class="nav toggle">
							<a id="menu_toggle"><i class="fa fa-bars"></i></a>
						</div>

						<ul class="nav navbar-nav navbar-right">
							<li class="">
								<a href="javascript:;" class="user-profile dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
									<img src="node_modules/gentelella/production/images/img.jpg" alt="">Manfred Mancx
									<span class=" fa fa-angle-down"></span>
								</a>
								<ul class="dropdown-menu dropdown-usermenu pull-right">
									<li><a href="javascript:;">  Profile</a>
									</li>
									<li>
										<a href="javascript:;">
											<span class="badge bg-red pull-right">50%</span>
											<span>Settings</span>
										</a>
									</li>
									<li>
										<a href="javascript:;">Help</a>
									</li>
									<li><a href="login.html"><i class="fa fa-sign-out pull-right"></i> Log Out</a>
									</li>
								</ul>
							</li>

							<li role="presentation" class="dropdown">
								<a href="javascript:;" class="dropdown-toggle info-number" data-toggle="dropdown" aria-expanded="false">
									<i class="fa fa-envelope-o"></i>
									<span class="badge bg-green">6</span>
								</a>
								<ul id="menu1" class="dropdown-menu list-unstyled msg_list" role="menu">
									<li>
										<a>
											<span class="image">
												  <img src="node_modules/gentelella/production/images/img.jpg" alt="Profile Image">
											  </span>
											<span>
												  <span>Aineko</span>
											<span class="time">3 mins ago</span>
											</span>
											<span class="message">
												  There is no escaping me Manfred. See you soon. 
											  </span>
										</a>
									</li>
									<li>
										<a>
											<span class="image">
												  <img src="node_modules/gentelella/production/images/img.jpg" alt="Profile Image">
											  </span>
											<span>
												  <span>Bob Franklin</span>
											<span class="time">3 mins ago</span>
											</span>
											<span class="message">
												  MANFRED! Aineko as escaped. Contact me at once.
											  </span>
										</a>
									</li>
									<li>
										<a>
											<span class="image">
												  <img src="node_modules/gentelella/production/images/img.jpg" alt="Profile Image">
											  </span>
											<span>
												  <span>Annette Dimarcos</span>
											<span class="time">3 mins ago</span>
											</span>
											<span class="message">
												  There is a party today and I know just what high heels I want you to wear this time...
											  </span>
										</a>
									</li>
									<li>
										<a>
											<span class="image">
												  <img src="node_modules/gentelella/production/images/img.jpg" alt="Profile Image">
											  </span>
											<span>
												  <span>Pamela</span>
											<span class="time">3 mins ago</span>
											</span>
											<span class="message">
												  I am going to find you Manfred. You know what they say, only death and taxes are certain.
											  </span>
										</a>
									</li>
									<li>
										<div class="text-center">
											<a>
												<strong>See All Alerts</strong>
												<i class="fa fa-angle-right"></i>
											</a>
										</div>
									</li>
								</ul>
							</li>

						</ul>
					</nav>
				</div>

			</div>
			<!-- top nav / -->
			<div class="right_col">
				<div class="row">
					<div class="col-md-4">
						<div class="col-md-12">
							<div class="x_panel">
								<div class="x_title">
									<h2>Humidity</h2>
									<ul class="nav navbar-right panel_toolbox">
										<li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
										</li>
										<li class="dropdown">
											<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
											<ul class="dropdown-menu" role="menu">
												<li><a href="#">Settings 1</a>
												</li>
												<li><a href="#">Settings 2</a>
												</li>
											</ul>
										</li>
										<li><a class="close-link"><i class="fa fa-close"></i></a></li>
									</ul>
									<div class="clearfix"></div>

								</div>
								<div class="x_content"><canvas id="humidity" width="250" height="250"></canvas></div>
							</div>
						</div>
						<div class="col-md-12">
							<div class="x_panel">
								<div class="x_title">
									<h2>Temperature</h2>
									<ul class="nav navbar-right panel_toolbox">
										<li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
										</li>
										<li class="dropdown">
											<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
											<ul class="dropdown-menu" role="menu">
												<li><a href="#">Settings 1</a>
												</li>
												<li><a href="#">Settings 2</a>
												</li>
											</ul>
										</li>
										<li><a class="close-link"><i class="fa fa-close"></i></a></li>
									</ul>
									<div class="clearfix"></div>

								</div>
								<div class="x_content"><canvas id="temperature" width="250" height="250"></canvas></div>
							</div>
						</div>
					</div>
					<!-- 
					We don't have a CO2 sensor right now
					<div class="col-md-4">
						<div class="x_panel">
							<div class="x_title">
								<h2>Carbon Dioxide</h2>
								<ul class="nav navbar-right panel_toolbox">
									<li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
									</li>
									<li class="dropdown">
										<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
										<ul class="dropdown-menu" role="menu">
											<li><a href="#">Settings 1</a>
											</li>
											<li><a href="#">Settings 2</a>
											</li>
										</ul>
									</li>
									<li><a class="close-link"><i class="fa fa-close"></i></a></li>
								</ul>
								<div class="clearfix"></div>

							</div>
							<div class="x_content"><canvas id="co2" width="250" height="250"></canvas></div>
						</div>
					</div>
					-->

					<div class="col-md-8 text-center">
						<div id="map"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script src="node_modules/jquery/dist/jquery.min.js"></script>
<script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="node_modules/leaflet/dist/leaflet.js"></script>
<script src="node_modules/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="node_modules/chart.js/dist/Chart.min.js"></script>
<script src="node_modules/gentelella/vendors/fastclick/lib/fastclick.js"></script>
<script src="node_modules/gentelella/build/js/custom.js"></script>
<script src="assets/js/auth.js"></script>

<script type="text/javascript">
	// GET JSON
	var dataUrl = 'http://labs.brunoamaral.eu/SparroWatch/web/demo.json';

	$.ajax({
		method: "GET",
		dataType: 'json',
		url: dataUrl,
	}).done(function(data){
		var nodes = [];
		var markers = [];
		for (var i = 0; i < data.length; i++) {
			var array_nodes = [data[i].latitude, data[i].longitude, parseInt(data[i].temperature[0].reading, 10) / 100]; //we divide temperature by 100 to build the heatmap with a correponding gradient
			nodes.push(array_nodes);
			var array_markers = [data[i].latitude, data[i].longitude];
			markers.push(array_markers)
		}

		console.log(markers + ' markers')
		console.log(nodes + ' nodes')

		buildMap(nodes, markers);

		// get average of readings
		function getAverage(variable_array) {
			var sum = 0;
			for (var i = 0; i < variable_array.length; i++){
				sum += parseInt( variable_array[i], 10 )
			}

			var average = sum / variable_array.length;
			return average;
		}

		// get average temperature reading
		var temperature_array = [];
		for (var i = 0; i < data.length; i++){ temperature_array.push(data[i].temperature[0].reading) }
		var current_temperature = getAverage(temperature_array);
		console.log('temperature: ' + current_temperature)

		buildTemperatureChart(current_temperature);

		// get average humidity reading
		var humidity_array = [];
		for (var i = 0; i < data.length; i++){ humidity_array.push(data[i].humidity[0].reading) }
		var current_humidity = getAverage(humidity_array);
		console.log('humidity: ' + current_humidity)

		buildHumidityChart(current_humidity);

		// get average carbondioxide reading
		var carbondioxide_array = [];
		for (var i = 0; i < data.length; i++){ carbondioxide_array.push(data[i].carbondioxide[0].reading) }
		var current_carbondioxide = getAverage(carbondioxide_array);
		console.log('carbondioxide: ' + current_carbondioxide)
		
		// we don't need this for now.
		// buildCO2Chart(current_carbondioxide);

	}).fail( function(jqXHR){
		console.log(jqXHR);
	});

	// MAP
	function buildMap(nodes, markers){
		var map = new L.map('map');
		var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
		var osmAttrib = 'Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
		var osm = new L.TileLayer(osmUrl, {
			minZoom: 8,
			maxZoom: 19,
			attribution: osmAttrib
		});

		map.setView(new L.LatLng(38.7617806, -9.0956322), 18);
		map.addLayer(osm);

		for (var i = 0; i < nodes.length; i++){
			var marker = L.marker(markers[i]).addTo(map);
		}
		// MAP > HEATMAP

		var heat = L.heatLayer(nodes, { 
			radius: 50,
			max: 0.5,
			maxZoom: 8,
			gradient: { 0.1: 'blue', 0.20: 'orange', 0.40: 'red' },
			
		 }).addTo(map);
	}

	// CHARTS
	function buildHumidityChart(humidity_value){
		var chartHumidity = document.getElementById("humidity");
		var humidity = new Chart(chartHumidity, {
			type: 'pie',
			data: {
				labels: ["H2O", "O2"],
				datasets: [{
					data: [humidity_value, 100 - humidity_value],
					backgroundColor: [
						"#FF6384",
						"#36A2EB",
					],
					hoverBackgroundColor: [
						"#FF6384",
						"#36A2EB",
					]
				}]
			},
			options: {
				responsive: true,
			}
		});
	}

	function buildTemperatureChart(temperature_value){
		var chartTemperature = document.getElementById("temperature");
		var temperature = new Chart(chartTemperature, {
			type: 'bar',
			data: {
				labels: ["Current", "Average"],
				datasets: [{
					label: "Temperature",
					data: [temperature_value, 18],
					backgroundColor: [
						"#FF0000",
						"#FF0000",
					],
				}],
			},
			options: {
				scales: {
					yAxes: [{
						ticks: {
							max: 30,
							min: 17,
							stepSize: 1,
						},
					}],
				}
			},
		});
	}

	function buildCO2Chart(carbondioxide_value){
		var chartCo2 = document.getElementById("co2");
		var Co2 = new Chart(chartCo2, {
			type: 'pie',
			data: {
				labels: ["CO2", "Oxygen"],
				datasets: [{
					data: [carbondioxide_value, carbondioxide_value - 100],
					backgroundColor: [
						"#cccccc",
						"#36A2EB",
					],
					hoverBackgroundColor: [
						"#FF6384",
						"#36A2EB",
					]
				}]
			},
			options: {
				responsive: true,
			}
		});
	}
</script>

</html>
